services:
  smart_assistant_gateway:
    image: ghcr.io/home-smart-assistant/smart-assistant-gateway:${GATEWAY_IMAGE_TAG:-main}
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: http://+:8080
      Services__AgentBaseUrl: http://smart_assistant_agent:8091
      Services__HomeAssistantBridgeBaseUrl: http://smart_assistant_ha_bridge:8092
      WakeArbitration__LockTtlMs: ${WAKE_LOCK_TTL_MS:-8000}
      TextEncoding__Strict: ${GATEWAY_TEXT_ENCODING_STRICT:-true}
    ports:
      - "${GATEWAY_PORT:-8080}:8080"
    depends_on:
      - smart_assistant_agent
      - smart_assistant_ha_bridge

  smart_assistant_agent:
    image: ghcr.io/home-smart-assistant/smart-assistant-agent:${AGENT_IMAGE_TAG:-main}
    restart: unless-stopped
    environment:
      HA_BRIDGE_URL: http://smart_assistant_ha_bridge:8092
      AGENT_MEMORY_MAX_TURNS: ${AGENT_MEMORY_MAX_TURNS:-12}
      AGENT_TOOL_AUTO_EXECUTE: ${AGENT_TOOL_AUTO_EXECUTE:-true}
      TEXT_ENCODING_STRICT: ${AGENT_TEXT_ENCODING_STRICT:-true}
      LLM_ENABLED: ${LLM_ENABLED:-true}
      LLM_PROVIDER: ${LLM_PROVIDER:-ollama}
      LLM_MODEL: ${LLM_MODEL:-deepseek-r1:7b}
      LLM_TIMEOUT_SECONDS: ${LLM_TIMEOUT_SECONDS:-30}
      AGENT_USE_LLM_INTENT_ROUTER: ${AGENT_USE_LLM_INTENT_ROUTER:-true}
      AGENT_USE_LLM_TOOL_ROUTER: ${AGENT_USE_LLM_TOOL_ROUTER:-true}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    ports:
      - "${AGENT_PORT:-8091}:8091"
    depends_on:
      - smart_assistant_ha_bridge
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ${AGENT_MEMORY_DIR:-/opt/smart-assistant/data/agent-memory}:/app/data/memory

  smart_assistant_ha_bridge:
    image: ghcr.io/home-smart-assistant/smart-assistant-ha-bridge:${BRIDGE_IMAGE_TAG:-main}
    restart: unless-stopped
    environment:
      HA_BASE_URL: ${HA_BASE_URL}
      HA_TOKEN: ${HA_TOKEN}
      HA_TIMEOUT_SEC: ${HA_TIMEOUT_SEC:-6}
      HA_CONTEXT_TIMEOUT_SEC: ${HA_CONTEXT_TIMEOUT_SEC:-8}
      TEXT_ENCODING_STRICT: ${BRIDGE_TEXT_ENCODING_STRICT:-true}
      HA_TOOL_CATALOG_PATH: /data/tool_catalog.json
      HA_DB_PATH: /data/bridge.db
      HA_LOG_PATH: /data/logs/operations.jsonl
      HA_LIGHT_LIVING_ROOM_ENTITY_ID: ${HA_LIGHT_LIVING_ROOM_ENTITY_ID:-}
      HA_LIGHT_BEDROOM_ENTITY_ID: ${HA_LIGHT_BEDROOM_ENTITY_ID:-}
      HA_LIGHT_STUDY_ENTITY_ID: ${HA_LIGHT_STUDY_ENTITY_ID:-}
      HA_CLIMATE_LIVING_ROOM_ENTITY_ID: ${HA_CLIMATE_LIVING_ROOM_ENTITY_ID:-}
      HA_CLIMATE_BEDROOM_ENTITY_ID: ${HA_CLIMATE_BEDROOM_ENTITY_ID:-}
      HA_CLIMATE_STUDY_ENTITY_ID: ${HA_CLIMATE_STUDY_ENTITY_ID:-}
      HA_COVER_LIVING_ROOM_ENTITY_ID: ${HA_COVER_LIVING_ROOM_ENTITY_ID:-}
      HA_COVER_BEDROOM_ENTITY_ID: ${HA_COVER_BEDROOM_ENTITY_ID:-}
      HA_COVER_STUDY_ENTITY_ID: ${HA_COVER_STUDY_ENTITY_ID:-}
    ports:
      - "${BRIDGE_PORT:-8092}:8092"
    volumes:
      - ${BRIDGE_DATA_DIR:-/opt/smart-assistant/data/ha-bridge}:/data
